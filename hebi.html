<!DOCTYPE html>
<html lang="zh-CN">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Hebi</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
    <style>
canvas {
	position: absolute
}
.mycan {
	width: 800px;
	height: 480px;
}
#hebican {
	z-index: 3
}
#canvas {
	z-index: 2
}
#myCanvas {
	z-index: 1
}
</style>
    <script>
        var x = 0, y = 0;
        var dir = 0, fdir = 0;
        function hebiGame(bgctx, hebictx) {
            var gripw = 20, startX = 10, startY = 10, wnum = 39, hnum = 23;
			var hebiColor = "#66BA98", foodColor = "#CD1277";
			var bgColor = "#CFDFFF", lineColor = 'orange';
			var foodNumber = 10;
			var timeWait=100;
			var score=0;
			var gameOverFlag = false;
			
			var makeMapArray = function (){
				var ret = new Array(wnum);
				for(var i=0; i<wnum; i++)
					ret[i] = new Array(hnum);
				return ret;
			}
			var map = makeMapArray();
			
            var makeMap = function (ctx, startX, startY, gripw, wnum, hnum) {
                ctx.strokeStyle = lineColor;
                var ty = startY, tx = startX;
                for (var i = 0; i < wnum; i++) {
                    ctx.strokeRect(tx, ty, gripw, gripw * hnum);
                    tx += gripw;
                }

                tx = startX;
                for (var i = 0; i < hnum; i++) {
                    ctx.strokeRect(tx, ty, gripw * wnum, gripw);
                    ty += gripw;
                }
            }
            bgctx.fillStyle = bgColor;
            bgctx.fillRect(0, 0, 800, 600);
            makeMap(bgctx, startX, startY, gripw, wnum, hnum);
			hebictx.clearRect(0,0,800,600);
			clearInputType();
			dir=0;fdir=0;

            var addBlk = function (x, y, color) {
                ctx.save();
                ctx.fillStyle = color;
                ctx.fillRect(startX + x * gripw, startY + y * gripw, gripw, gripw);
				map[x][y]=color;
                ctx.restore();
            }
            var delBlk = function (x, y) {
                ctx.clearRect(startX + x * gripw, startY + y * gripw, gripw, gripw);
				map[x][y]=null;
            }
			
			//获得0~x-1的随机数
			var getRandom = function(x){
				var ran = Math.random();
				return Math.floor(Math.random() * ( x ));
			}
			
			var newFood = function(){
				wnum = 39, hnum = 23;
				var x,y;
				do{
					x = getRandom(wnum);
					y = getRandom(hnum);
				}while(map[x][y]!=null);
				return {x:x, y:y};
			}
			
            var ctx = hebictx;
            var x = 0, y = 0;
            var go = [{x: 1, y: 0}, {x: -1, y: 0}, {x: 0, y: -1}, {x: 0, y: 1}];
			var DIRECTION = {right:0, left:1, up:2, down:3};
			
			var newHebi = function (x,y,dir){
				var ret = [];
				var nx=x, ny=y;
				for(var i=0; i<3; i++){
					ret.push({x:nx,y:ny});
					addBlk(nx,ny,hebiColor);
					nx+=go[dir].x;
					ny+=go[dir].y;
				}
				return ret;
			}
			
			var gameOver = function(){
				gameOverFlag = true;
				alert("Game Over! Your score is "+score+ " !");
				hebiGame(bgctx,hebictx);
			}
			
            var hebiStep = function (hebi) {
				if(gameOverFlag)return;
                var nx = hebi[hebi.length-1].x;
                var ny = hebi[hebi.length-1].y;
                nx += go[dir].x;
                ny += go[dir].y;
                nx = (nx + wnum) % wnum;
                ny = (ny + hnum) % hnum;
                //if ((nx < 0) || (ny < 0) || (nx >= wnum) || (ny >= hnum))return;
				if(map[nx][ny]==foodColor){
					var food = newFood();
					addBlk(food.x,food.y,foodColor);
					delBlk(nx,ny);
					score++;
					if(timeWait>=10) timeWait--;
				}else{
					var first = hebi.shift();
					delBlk(first.x, first.y);
				}
				if (map[nx][ny]!=null){
					gameOver();
					return;
				}
				x = nx;
				y = ny;
				hebi.push({x:x, y:y});
				addBlk(x, y,hebiColor);
				fdir = dir;
				setTimeout(hebiStep, timeWait, oneHebi);
            }
			var oneHebi = newHebi(1,1,0);
			for(i=0; i<foodNumber; i++){
				var food = newFood();
				addBlk(food.x, food.y, foodColor);
			}
            hebiStep(oneHebi);

        }

        var inputType = {
            right: false,
            up: false,
            left: false,
            down: false,
            quit: false
        };
		
		function clearInputType(){
			inputType = {
				right: false,
				up: false,
				left: false,
				down: false,
				quit: false
			};
		}

        function keyInput(keyDown, event) {
            //console.log(keyDown, event);
            var KEY = {
                D: 68,
                W: 87,
                A: 65,
                S: 83,
                RIGHT: 39,
                UP: 38,
                LEFT: 37,
                DOWN: 40,
                Q: 81
            };
            var keynum;
            var keychar;
            var numcheck;

            if (window.event) // IE
            {
                keynum = event.keyCode
            }
            else if (event.which) // Netscape/Firefox/Opera
            {
                keynum = event.which
            }
            function press(code) {
                switch (code) {
                    case KEY.RIGHT:
                    case KEY.D:
                        inputType.right = true;
                        break;

                    case KEY.UP:
                    case KEY.W:
                        inputType.up = true;
                        break;

                    case KEY.LEFT:
                    case KEY.A:
                        inputType.left = true;
                        break;

                    case KEY.DOWN:
                    case KEY.S:
                        inputType.down = true;
                        break;

                    case KEY.Q:
                        inputType.quit = true;
                        break;
                }
            }

            function release(code) {
                switch (code) {
                    case KEY.RIGHT:
                    case KEY.D:
                        inputType.right = false;
                        break;

                    case KEY.UP:
                    case KEY.W:
                        inputType.up = false;
                        break;

                    case KEY.LEFT:
                    case KEY.A:
                        inputType.left = false;
                        break;

                    case KEY.DOWN:
                    case KEY.S:
                        inputType.down = false;
                        break;

                    case KEY.Q:
                        inputType.quit = false;
                        break;

                    default:
                        console.log('unrecognized key code: ' + code);
                        break;
                }
            }

            if (keyDown)press(keynum);
            else release(keynum);
			
			var newDir=-1;
            if (inputType.right)newDir = 0;
            else if (inputType.left)newDir = 1;
            else if (inputType.up)newDir = 2;
            else if (inputType.down)newDir = 3;
			if(newDir!=-1 && newDir!=(fdir^1))dir = newDir;
            //console.log(inputType);
            return false;
        }
    </script>
    </head>
    <body onkeydown="return keyInput(true,event)" onkeyup="return keyInput(false,event)">
<div class="container">
      <div class="row">
    <div class="col-md-12">
          <canvas class="mycan" id="myCanvas" width="800" height="480"
                    ></canvas>
          <canvas class="mycan" id="canvas" width="800" height="480"
                    ></canvas>
          <canvas class="mycan" id="hebican" width="800" height="480"
                    ></canvas>
        </div>
  </div>
      <div class="row">
    <div class="col-md-12">
          <p id="warnWords"></p>
        </div>
  </div>
    </div>
<!-- /.container --> 

<!-- jQuery (necessary for Bootstrap's JavaScript plugins) --> 
<script src="js/jquery.js"></script> 
<!-- Include all compiled plugins (below), or include individual files as needed --> 
<script src="js/bootstrap.min.js"></script> 
<script>
    var canvas = $("#myCanvas")[0];
    if (!canvas.getContext) {
        $("#warnWords").html("浏览器不支持canvas,请使用Chrome浏览器.");
    }
    var ctx = canvas.getContext('2d');
    ctx.fillStyle = '#CFDFEF';
    ctx.fillRect(0, 0, 300, 1000);
    ctx.fillStyle = '#000000';

    var i = 0;
    while (i < 100) {
        ctx.fillRect(15 * i, 0, 10, 10);
        i++;
    }
    var hebictx = $("#hebican")[0].getContext('2d');
    hebiGame(ctx, hebictx);
</script>
</body>
</html>